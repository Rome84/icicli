import Data.Aeson
import Data.Maybe (isJust)
import qualified Data.ByteString.Lazy.Char8 as LB
import Test.HUnit
import qualified Icinga.Models.Host as H
import qualified Icinga.Models.Service as S
import qualified Icinga.Models.Response as R
import System.Exit

restoreHost msg = TestCase $ do
  let input = LB.pack msg
      (Just inputHost) = decode input :: Maybe H.Host
      output = encode inputHost
      (Just outputHost) = decode output :: Maybe H.Host
  assertEqual "Host values should be equal" inputHost outputHost

restoreHostResponse msg = TestCase $ do
  let input = LB.pack msg
      (Just inputResponse) = decode input :: Maybe (R.Response H.Host)
      output = encode inputResponse
      (Just outputResponse) = decode output :: Maybe (R.Response H.Host)
  assertEqual "Host response values should be equal" inputResponse outputResponse

restoreService msg = TestCase $ do
  let input = LB.pack msg
      (Just inputService) = decode input :: Maybe S.Service
      output = encode inputService
      (Just outputService) = decode output :: Maybe S.Service
  assertEqual "Service values should be equal" inputService outputService

restoreServiceResponse msg = TestCase $ do
  let input = LB.pack msg
      (Just inputResponse) = decode input :: Maybe (R.Response S.Service)
      output = encode inputResponse
      (Just outputResponse) = decode output :: Maybe (R.Response S.Service)
  assertEqual "Service response values should be equal" inputResponse outputResponse

tests
  = TestList
  [ TestLabel "It should be possible to restore host (1)" $ restoreHost "{\"__name\":\"HOSTNAME\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"address\":\"127.0.0.1\",\"address6\":\"\",\"check_attempt\":1.0,\"check_command\":\"hostalive\",\"check_interval\":60.0,\"display_name\":\"HOSTNAME\",\"enable_active_checks\":true,\"enable_event_handler\":true,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"flapping\":false,\"flapping_last_change\":1460663810.8840420246,\"flapping_negative\":2384.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[\"windows-servers\",\"windows-servers\"],\"ha_mode\":0.0,\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1460663810.8840000629,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_ping\",\"-H\",\"127.0.0.1\",\"-c\",\"5000,100%\",\"-w\",\"3000,80%\"],\"execution_end\":1460663810.883908987,\"execution_start\":1460663806.8805880547,\"exit_status\":0.0,\"output\":\"PING OK - Packet loss = 0%, RTA = 0.80 ms\",\"performance_data\":[\"rta=0.802000ms;3000.000000;5000.000000;0.000000\",\"pl=0%;80;100;0\"],\"schedule_end\":1460663810.8840000629,\"schedule_start\":1460663866.879999876,\"state\":0.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0}},\"last_hard_state\":0.0,\"last_hard_state_change\":1458824644.4995191097,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":0.0,\"last_state_change\":1458824614.5053360462,\"last_state_down\":1458824580.494437933,\"last_state_type\":1.0,\"last_state_unreachable\":0.0,\"last_state_up\":1460663810.8840250969,\"max_check_attempts\":3.0,\"name\":\"HOSTNAME\",\"next_check\":1460663866.879999876,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":{\"vars.routing_key\":\"DEIT-Rwm\"},\"package\":\"_api\",\"paused\":false,\"retry_interval\":30.0,\"state\":0.0,\"state_type\":1.0,\"templates\":[\"HOSTNAME\",\"generic-host\"],\"type\":\"Host\",\"vars\":{\"app_env\":\"prod\",\"hostgroups\":\"windows-servers\",\"os\":\"Windows\",\"routing_key\":\"DEIT-Rwm\"},\"version\":1460468245.6098489761,\"volatile\":false,\"zone\":\"\"}"
  , TestLabel "It should be possible to restore host (1)" $ restoreHost "{\"__name\":\"HOSTNAME\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"address\":\"127.0.0.1\",\"address6\":\"\",\"check_attempt\":1.0,\"check_command\":\"hostalive\",\"check_interval\":60.0,\"display_name\":\"HOSTNAME\",\"enable_active_checks\":true,\"enable_event_handler\":true,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"flapping\":false,\"flapping_last_change\":1460975226.0459411144,\"flapping_negative\":2026.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[\"linux-servers\"],\"ha_mode\":0.0,\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1460975226.045883894,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_ping\",\"-H\",\"127.0.0.1\",\"-c\",\"5000,100%\",\"-w\",\"3000,80%\"],\"execution_end\":1460975226.0457799435,\"execution_start\":1460975222.0404970646,\"exit_status\":0.0,\"output\":\"PING OK - Packet loss = 0%, RTA = 0.04 ms\",\"performance_data\":[\"rta=0.039000ms;3000.000000;5000.000000;0.000000\",\"pl=0%;80;100;0\"],\"schedule_end\":1460975226.045883894,\"schedule_start\":1460975282.0399999619,\"state\":0.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0}},\"last_hard_state\":0.0,\"last_hard_state_change\":1458052538.2146699429,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":0.0,\"last_state_change\":1458052538.2146699429,\"last_state_down\":0.0,\"last_state_type\":1.0,\"last_state_unreachable\":0.0,\"last_state_up\":1460975226.0459189415,\"max_check_attempts\":3.0,\"name\":\"HOSTNAME\",\"next_check\":1460975282.0399999619,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":null,\"package\":\"_etc\",\"paused\":false,\"retry_interval\":30.0,\"state\":0.0,\"state_type\":1.0,\"templates\":[\"HOSTNAME\",\"generic-host\"],\"type\":\"Host\",\"vars\":{\"app_env\":\"test\",\"os\":\"Linux\",\"routing_key\":\"TTEC-Tools\"},\"version\":0.0,\"volatile\":false,\"zone\":\"master\"}"
  , TestLabel "It should be possible to restore host responces (1)" $ restoreHostResponse "{\"results\":[{\"attrs\":{\"__name\":\"HOSTNAME\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"address\":\"127.0.0.1\",\"address6\":\"\",\"check_attempt\":1.0,\"check_command\":\"hostalive\",\"check_interval\":60.0,\"display_name\":\"HOSTNAME\",\"enable_active_checks\":true,\"enable_event_handler\":true,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"flapping\":false,\"flapping_last_change\":1460663810.8840420246,\"flapping_negative\":2384.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[\"windows-servers\",\"windows-servers\"],\"ha_mode\":0.0,\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1460663810.8840000629,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_ping\",\"-H\",\"127.0.0.1\",\"-c\",\"5000,100%\",\"-w\",\"3000,80%\"],\"execution_end\":1460663810.883908987,\"execution_start\":1460663806.8805880547,\"exit_status\":0.0,\"output\":\"PING OK - Packet loss = 0%, RTA = 0.80 ms\",\"performance_data\":[\"rta=0.802000ms;3000.000000;5000.000000;0.000000\",\"pl=0%;80;100;0\"],\"schedule_end\":1460663810.8840000629,\"schedule_start\":1460663866.879999876,\"state\":0.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0}},\"last_hard_state\":0.0,\"last_hard_state_change\":1458824644.4995191097,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":0.0,\"last_state_change\":1458824614.5053360462,\"last_state_down\":1458824580.494437933,\"last_state_type\":1.0,\"last_state_unreachable\":0.0,\"last_state_up\":1460663810.8840250969,\"max_check_attempts\":3.0,\"name\":\"HOSTNAME\",\"next_check\":1460663866.879999876,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":{\"vars.routing_key\":\"DEIT-Rwm\"},\"package\":\"_api\",\"paused\":false,\"retry_interval\":30.0,\"state\":0.0,\"state_type\":1.0,\"templates\":[\"HOSTNAME\",\"generic-host\"],\"type\":\"Host\",\"vars\":{\"app_env\":\"prod\",\"hostgroups\":\"windows-servers\",\"os\":\"Windows\",\"routing_key\":\"DEIT-Rwm\"},\"version\":1460468245.6098489761,\"volatile\":false,\"zone\":\"\"},\"joins\":{},\"meta\":{},\"name\":\"HOSTNAME\",\"type\":\"Host\"}]}"
  , TestLabel "It should be possible to restore host responces (2)" $ restoreHostResponse "{\"results\":[{\"attrs\":{\"__name\":\"HOSTNAME\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"address\":\"127.0.0.1\",\"address6\":\"\",\"check_attempt\":1.0,\"check_command\":\"hostalive\",\"check_interval\":60.0,\"display_name\":\"HOSTNAME\",\"enable_active_checks\":true,\"enable_event_handler\":true,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"flapping\":false,\"flapping_last_change\":1460975226.0459411144,\"flapping_negative\":2026.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[\"linux-servers\"],\"ha_mode\":0.0,\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1460975226.045883894,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_ping\",\"-H\",\"127.0.0.1\",\"-c\",\"5000,100%\",\"-w\",\"3000,80%\"],\"execution_end\":1460975226.0457799435,\"execution_start\":1460975222.0404970646,\"exit_status\":0.0,\"output\":\"PING OK - Packet loss = 0%, RTA = 0.04 ms\",\"performance_data\":[\"rta=0.039000ms;3000.000000;5000.000000;0.000000\",\"pl=0%;80;100;0\"],\"schedule_end\":1460975226.045883894,\"schedule_start\":1460975282.0399999619,\"state\":0.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0}},\"last_hard_state\":0.0,\"last_hard_state_change\":1458052538.2146699429,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":0.0,\"last_state_change\":1458052538.2146699429,\"last_state_down\":0.0,\"last_state_type\":1.0,\"last_state_unreachable\":0.0,\"last_state_up\":1460975226.0459189415,\"max_check_attempts\":3.0,\"name\":\"HOSTNAME\",\"next_check\":1460975282.0399999619,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":null,\"package\":\"_etc\",\"paused\":false,\"retry_interval\":30.0,\"state\":0.0,\"state_type\":1.0,\"templates\":[\"HOSTNAME\",\"generic-host\"],\"type\":\"Host\",\"vars\":{\"app_env\":\"test\",\"os\":\"Linux\",\"routing_key\":\"TTEC-Tools\"},\"version\":0.0,\"volatile\":false,\"zone\":\"master\"},\"joins\":{},\"meta\":{},\"name\":\"HOSTNAME\",\"type\":\"Host\"}]}"
  , TestLabel "It should be possible to restore host responces (3)" $ restoreHostResponse "{\"results\":[{\"attrs\":{\"__name\":\"HOSTNAME\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"address\":\"127.0.0.1\",\"address6\":\"\",\"check_attempt\":1.0,\"check_command\":\"hostalive\",\"check_interval\":300.0,\"check_period\":\"\",\"check_timeout\":null,\"command_endpoint\":\"\",\"display_name\":\"HOSTNAME\",\"enable_active_checks\":true,\"enable_event_handler\":false,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"event_command\":\"\",\"flapping\":false,\"flapping_last_change\":1461221573.1994841099,\"flapping_negative\":2096.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[\"fxcore-test\",\"windows-servers\",\"fxcore\"],\"ha_mode\":0.0,\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1461221573.199450016,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_ping\",\"-H\",\"127.0.0.1\",\"-c\",\"5000,100%\",\"-w\",\"3000,80%\"],\"execution_end\":1461221573.1993899345,\"execution_start\":1461221569.1704070568,\"exit_status\":0.0,\"output\":\"PING OK - Packet loss = 0%, RTA = 2.26 ms\",\"performance_data\":[\"rta=2.255000ms;3000.000000;5000.000000;0.000000\",\"pl=0%;80;100;0\"],\"schedule_end\":1461221573.199450016,\"schedule_start\":1461221869.1699998379,\"state\":0.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":0.0,\"state_type\":1.0}},\"last_hard_state\":0.0,\"last_hard_state_change\":1461149529.893460989,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":0.0,\"last_state_change\":1461149529.893460989,\"last_state_down\":0.0,\"last_state_type\":1.0,\"last_state_unreachable\":0.0,\"last_state_up\":1461221573.1994709969,\"max_check_attempts\":3.0,\"name\":\"HOSTNAME\",\"next_check\":1461221869.1699998379,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":null,\"package\":\"_api\",\"paused\":false,\"retry_interval\":60.0,\"state\":0.0,\"state_type\":1.0,\"templates\":[\"HOSTNAME\"],\"type\":\"Host\",\"vars\":{\"os\":\"Windows\",\"routing_key\":\"routing-key\"},\"version\":1461149359.2692770958,\"volatile\":false,\"zone\":\"\"},\"joins\":{},\"meta\":{},\"name\":\"HOSTNAME\",\"type\":\"Host\"}]}"
  , TestLabel "It should be possible to restore service (1)" $ restoreService "{\"__name\":\"HOSTNAME!test-svc\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"check_attempt\":1.0,\"check_command\":\"passive\",\"check_interval\":300.0,\"check_period\":\"\",\"check_timeout\":null,\"command_endpoint\":\"\",\"display_name\":\"Test Service\",\"enable_active_checks\":true,\"enable_event_handler\":false,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"event_command\":\"\",\"flapping\":false,\"flapping_last_change\":1461223095.7521750927,\"flapping_negative\":300.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[],\"ha_mode\":0.0,\"host_name\":\"HOSTNAME\",\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1461223095.7521300316,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_dummy\",3.0,\"No Passive Check Result Received.\"],\"execution_end\":1461223095.7520539761,\"execution_start\":1461223095.7504200935,\"exit_status\":3.0,\"output\":\"UNKNOWN: No Passive Check Result Received.\",\"performance_data\":[],\"schedule_end\":1461223095.7521300316,\"schedule_start\":1461223395.75,\"state\":3.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":3.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":3.0,\"state_type\":1.0}},\"last_hard_state\":3.0,\"last_hard_state_change\":1461222495.7518219948,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":3.0,\"last_state_change\":1461209392.4648869038,\"last_state_critical\":0.0,\"last_state_ok\":0.0,\"last_state_type\":1.0,\"last_state_unknown\":1461223095.7521550655,\"last_state_unreachable\":0.0,\"last_state_warning\":0.0,\"max_check_attempts\":3.0,\"name\":\"test-svc\",\"next_check\":1461223395.75,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":null,\"package\":\"_api\",\"paused\":false,\"retry_interval\":60.0,\"state\":3.0,\"state_type\":1.0,\"templates\":[\"test-svc\"],\"type\":\"Service\",\"vars\":{\"routing_key\":\"routing-key\"},\"version\":1461222468.885602951,\"volatile\":false,\"zone\":\"\"}"
  , TestLabel "It should be possible to restore service responces (1)" $ restoreServiceResponse "{\"results\":[{\"attrs\":{\"__name\":\"HOSTNAME!test-svc\",\"acknowledgement\":0.0,\"acknowledgement_expiry\":0.0,\"action_url\":\"\",\"active\":true,\"check_attempt\":1.0,\"check_command\":\"passive\",\"check_interval\":300.0,\"check_period\":\"\",\"check_timeout\":null,\"command_endpoint\":\"\",\"display_name\":\"Test Service\",\"enable_active_checks\":true,\"enable_event_handler\":false,\"enable_flapping\":false,\"enable_notifications\":true,\"enable_passive_checks\":true,\"enable_perfdata\":true,\"event_command\":\"\",\"flapping\":false,\"flapping_last_change\":1461223095.7521750927,\"flapping_negative\":300.0,\"flapping_positive\":0.0,\"flapping_threshold\":30.0,\"force_next_check\":false,\"force_next_notification\":false,\"groups\":[],\"ha_mode\":0.0,\"host_name\":\"HOSTNAME\",\"icon_image\":\"\",\"icon_image_alt\":\"\",\"last_check\":1461223095.7521300316,\"last_check_result\":{\"active\":true,\"check_source\":\"HOSTNAME\",\"command\":[\"/usr/local/nagios/libexec//check_dummy\",3.0,\"No Passive Check Result Received.\"],\"execution_end\":1461223095.7520539761,\"execution_start\":1461223095.7504200935,\"exit_status\":3.0,\"output\":\"UNKNOWN: No Passive Check Result Received.\",\"performance_data\":[],\"schedule_end\":1461223095.7521300316,\"schedule_start\":1461223395.75,\"state\":3.0,\"type\":\"CheckResult\",\"vars_after\":{\"attempt\":1.0,\"reachable\":true,\"state\":3.0,\"state_type\":1.0},\"vars_before\":{\"attempt\":1.0,\"reachable\":true,\"state\":3.0,\"state_type\":1.0}},\"last_hard_state\":3.0,\"last_hard_state_change\":1461222495.7518219948,\"last_in_downtime\":false,\"last_reachable\":true,\"last_state\":3.0,\"last_state_change\":1461209392.4648869038,\"last_state_critical\":0.0,\"last_state_ok\":0.0,\"last_state_type\":1.0,\"last_state_unknown\":1461223095.7521550655,\"last_state_unreachable\":0.0,\"last_state_warning\":0.0,\"max_check_attempts\":3.0,\"name\":\"test-svc\",\"next_check\":1461223395.75,\"notes\":\"\",\"notes_url\":\"\",\"original_attributes\":null,\"package\":\"_api\",\"paused\":false,\"retry_interval\":60.0,\"state\":3.0,\"state_type\":1.0,\"templates\":[\"test-svc\"],\"type\":\"Service\",\"vars\":{\"routing_key\":\"routing-key\"},\"version\":1461222468.885602951,\"volatile\":false,\"zone\":\"\"},\"joins\":{},\"meta\":{},\"name\":\"HOSTNAME!test-svc\",\"type\":\"Service\"}]}"
  ]

main :: IO ()
main = do
  result <- runTestTT tests
  case errors result + failures result of
    0 -> exitSuccess
    _ -> exitWith $ ExitFailure 1
